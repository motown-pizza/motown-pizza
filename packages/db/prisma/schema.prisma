// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

// npx prisma migrate dev --name init -> sync database
// npx prisma db push -> sync database
// npx prisma studio -> view database
// npx prisma generate -> generate prisma client

generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL") // uses connection pooling
  directUrl = env("DIRECT_URL") // uses a direct connection
}

// enums

enum Role {
  DEV
  ADMIN
  USER
  EMPLOYEE
  SUPERVISOR
  TRANSPORTER
}

enum Status {
  ACTIVE
  INACTIVE
  DRAFT
  PUBLISHED
}

enum SyncStatus {
  PENDING
  SYNCED
  SAVED
  ERROR
  DELETED
}

enum ProductType {
  PIZZA
  SIDE
  DRINK
  SOUP
  DESSERT
  SALAD
}

enum Size {
  SMALL
  MEDIUM
  LARGE
  EXTRALARGE
}

enum ProductDietaryType {
  MEATY
  VEGGIE
  VEGAN
  NEUTRAL
}

enum OrderSource {
  WEBSITE
  POS
}

enum OrderStatus {
  DRAFT // order created but not finalized
  PROCESSING // awaiting order payment confirmation
  FINALIZED // order confirmed, stock will be deducted
  PREPARING // kitchen has started production
  READY // kitchen finished, waiting for pickup/delivery
  OUT_FOR_DELIVERY // driver en route (delivery only)
  COMPLETED // order delivered/picked up successfully
  CANCELLED // order cancelled before or after finalization
}

enum OrderFulfilmentType {
  COLLECTION
  DELIVERY
  DINE_IN
}

enum OrderPaymentStatus {
  PENDING
  AUTHORIZED
  CONFIRMED
  FAILED
  CANCELLED
  REFUNDED
}

enum OrderTime {
  NOW
  LATER
}

enum OrderPaymentMethod {
  ONLINE
  CASH
}

enum TransportVehicleType {
  MOPED
  CAR
}

enum StockMovementType {
  PURCHASE
  CONSUMPTION
  ADJUSTMENT
}

enum MeasurementUnitType {
  GRAMS
  MILLILITRES
}

enum DeliveryStatus {
  PENDING
  SHCEDULED
  OUT_FOR_DELIVERY
  DELIVERED
  FAILED
  CANCELLED
  RETURNED
}

enum TableStatus {
  BOOKED
  AVAILABLE
  OCCUPIED
}

enum TableBookingStatus {
  BOOKED // awaiting an order
  WAITING // awaiting an order
  RECEIVED // received order(s)
  DONE // done with order(s)
}

// models

model Profile {
  id         String  @id
  user_name  String?
  first_name String?
  last_name  String?
  email      String?
  bio        String?
  avatar     String?
  phone      String?
  role       Role    @default(USER)

  posts          Post[]
  comments       Comment[]
  orders         Order[]
  order_items    OrderItem[]
  cart_items     CartItem[]
  wishlist_items WishlistItem[]
  deliveries     Delivery[] // for transporters

  status      Status     @default(ACTIVE)
  sync_status SyncStatus @default(SYNCED)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("profiles")
}

model Post {
  id             String  @id @default(uuid())
  image          String
  title          String
  excerpt        String
  content        String
  allow_comments Boolean @default(true)
  view_count     Int     @default(0)

  profile     Profile?  @relation(fields: [profile_id], references: [id], onDelete: Cascade)
  profile_id  String?
  category    Category? @relation(fields: [category_id], references: [id], onDelete: SetNull)
  category_id String?

  comments Comment[]

  status      Status     @default(DRAFT)
  sync_status SyncStatus @default(SYNCED)
  created_at  DateTime   @default(now())
  updated_at  DateTime   @updatedAt

  @@map(name: "posts")
}

model Category {
  id    String @id @default(uuid())
  title String

  posts Post[]

  status      Status     @default(ACTIVE)
  sync_status SyncStatus @default(SYNCED)
  created_at  DateTime   @default(now())
  updated_at  DateTime   @updatedAt

  @@map(name: "categories")
}

model Comment {
  id         String  @id @default(uuid())
  name       String?
  content    String
  comment_id String?

  post       Post     @relation(fields: [post_id], references: [id], onDelete: Cascade)
  post_id    String
  profile    Profile? @relation(fields: [profile_id], references: [id], onDelete: Cascade)
  profile_id String?

  status      Status     @default(ACTIVE)
  sync_status SyncStatus @default(SYNCED)
  created_at  DateTime   @default(now())
  updated_at  DateTime   @updatedAt

  @@map(name: "comments")
}

model Product {
  id            String              @id @default(uuid())
  image         String
  image_id      String?
  title         String
  description   String
  type          ProductType
  dietary_class ProductDietaryType?

  product_variants ProductVariant[]

  status      Status     @default(DRAFT)
  sync_status SyncStatus @default(SYNCED)
  created_at  DateTime   @default(now())
  updated_at  DateTime   @updatedAt

  @@map(name: "products")
}

model ProductVariant {
  id          String  @id @default(uuid())
  title       String?
  size        Size
  price       Float
  measurement String?

  product    Product @relation(fields: [product_id], references: [id], onDelete: Cascade)
  product_id String

  recipie_items RecipieItem[]
  order_items   OrderItem[]
  cart_items    CartItem[]
  wihlist_items WishlistItem[]

  status      Status     @default(DRAFT)
  sync_status SyncStatus @default(SYNCED)
  created_at  DateTime   @default(now())
  updated_at  DateTime   @updatedAt

  @@map(name: "product_variants")
}

model Ingredient {
  id               String              @id @default(uuid())
  name             String
  unit             MeasurementUnitType
  stock_quantity   Float
  low_stock_margin Float
  stockout_margin  Float
  stock_capacity   Float

  recipie_items   RecipieItem[]
  stock_movements StockMovement[]

  status      Status     @default(DRAFT)
  sync_status SyncStatus @default(SYNCED)
  created_at  DateTime   @default(now())
  updated_at  DateTime   @updatedAt

  @@map(name: "ingredients")
}

model RecipieItem {
  id              String              @id @default(uuid())
  quantity_needed Float
  unit            MeasurementUnitType

  product_variant    ProductVariant @relation(fields: [product_variant_id], references: [id], onDelete: Cascade)
  product_variant_id String
  ingredient         Ingredient     @relation(fields: [ingredient_id], references: [id], onDelete: Cascade)
  ingredient_id      String

  status      Status     @default(DRAFT)
  sync_status SyncStatus @default(SYNCED)
  created_at  DateTime   @default(now())
  updated_at  DateTime   @updatedAt

  @@map(name: "recipie_items")
}

model Order {
  id                   String              @id @default(uuid())
  source               OrderSource
  order_status         OrderStatus
  order_payment_status OrderPaymentStatus
  fulfillment_type     OrderFulfilmentType
  order_time           OrderTime
  payment_method       OrderPaymentMethod
  eta_estimate         String?
  customer_name        String
  customer_phone       String?
  guest_count          Int?
  tracking_code        String // (eg. NYC240115DK7QX9M2)

  profile          Profile?      @relation(fields: [profile_id], references: [id], onDelete: Cascade)
  profile_id       String?
  // store      Store?  @relation(fields: [store_id], references: [id], onDelete: Cascade)
  store_id         String?
  table_booking    TableBooking? @relation(fields: [table_booking_id], references: [id], onDelete: Cascade)
  table_booking_id String?

  order_items     OrderItem[]
  stock_movements StockMovement[]
  deliveries      Delivery[] // how many delivery attempts were made

  status      Status     @default(DRAFT)
  sync_status SyncStatus @default(SYNCED)
  created_at  DateTime   @default(now())
  updated_at  DateTime   @updatedAt

  @@map(name: "orders")
}

model Delivery {
  id              String         @id @default(uuid())
  delivery_status DeliveryStatus @default(PENDING)

  // time & schedule
  scheduled_date         DateTime? // planned delivery date
  scheduled_window_start DateTime? // scheduledWindowEnd â€“ time window
  dispatched_at          DateTime? // when courier left
  estimated_delivery_at  DateTime? // ETA shown to customer
  delivered_at           DateTime? // when delivery was completed

  // logistics & tracking
  vehicle_type TransportVehicleType? // bike, car, van, truck
  vehicle_id   String?
  distance_km  Float? // delivery distance
  delivery_fee Float? // cost of delivery

  // Proof of Delivery
  verfication_code String? // shared to only user, admin, supervisor accounts (not shared with transporter)

  // Failures & Exceptions
  status_reason        String? // reason for failure/cancellation
  failed_at            DateTime? // when it failed
  previous_delivery_id String? // link to previous failed/cancelled attempt

  profile    Profile @relation(fields: [profile_id], references: [id], onDelete: Cascade)
  profile_id String // courier
  order      Order   @relation(fields: [order_id], references: [id], onDelete: Cascade)
  order_id   String // order being delivered

  status      Status     @default(DRAFT)
  sync_status SyncStatus @default(SYNCED)
  created_at  DateTime   @default(now())
  updated_at  DateTime   @updatedAt

  @@map(name: "deliveries")
}

model OrderItem {
  id            String @id @default(uuid())
  quantity      Int
  price_at_sale Int

  profile            Profile?       @relation(fields: [profile_id], references: [id], onDelete: Cascade)
  profile_id         String?
  order              Order          @relation(fields: [order_id], references: [id], onDelete: Cascade)
  order_id           String
  product_variant    ProductVariant @relation(fields: [product_variant_id], references: [id], onDelete: Cascade)
  product_variant_id String

  status      Status     @default(DRAFT)
  sync_status SyncStatus @default(SYNCED)
  created_at  DateTime   @default(now())
  updated_at  DateTime   @updatedAt

  @@map(name: "order_items")
}

model Table {
  id           String @id @default(uuid())
  table_number String
  seat_count   Int
  // table_status TableStatus @default(AVAILABLE)

  tableBookings TableBooking[]

  status      Status     @default(DRAFT)
  sync_status SyncStatus @default(SYNCED)
  created_at  DateTime   @default(now())
  updated_at  DateTime   @updatedAt

  @@map(name: "tables")
}

model TableBooking {
  id                   String             @id @default(uuid())
  number_of_persons    Int // ie. table for x people
  table_booking_status TableBookingStatus @default(WAITING)

  table    Table  @relation(fields: [table_id], references: [id], onDelete: Cascade)
  table_id String

  orders Order[]

  status      Status     @default(DRAFT)
  sync_status SyncStatus @default(SYNCED)
  created_at  DateTime   @default(now())
  updated_at  DateTime   @updatedAt

  @@map(name: "table_bookings")
}

model CartItem {
  id       String @id @default(uuid())
  quantity Int    @default(1)

  profile            Profile?       @relation(fields: [profile_id], references: [id], onDelete: Cascade)
  profile_id         String?
  product_variant    ProductVariant @relation(fields: [product_variant_id], references: [id], onDelete: Cascade)
  product_variant_id String

  status      Status     @default(DRAFT)
  sync_status SyncStatus @default(SYNCED)
  created_at  DateTime   @default(now())
  updated_at  DateTime   @updatedAt

  @@map(name: "cart_items")
}

model WishlistItem {
  id       String @id @default(uuid())
  quantity Int    @default(1)

  profile            Profile        @relation(fields: [profile_id], references: [id], onDelete: Cascade)
  profile_id         String
  product_variant    ProductVariant @relation(fields: [product_variant_id], references: [id], onDelete: Cascade)
  product_variant_id String

  status      Status     @default(DRAFT)
  sync_status SyncStatus @default(SYNCED)
  created_at  DateTime   @default(now())
  updated_at  DateTime   @updatedAt

  @@map(name: "wishlist_items")
}

model StockMovement {
  id       String            @id @default(uuid())
  type     StockMovementType
  quantity Int

  order         Order?     @relation(fields: [order_id], references: [id], onDelete: Cascade)
  order_id      String?
  ingredient    Ingredient @relation(fields: [ingredient_id], references: [id], onDelete: Cascade)
  ingredient_id String

  status      Status     @default(DRAFT)
  sync_status SyncStatus @default(SYNCED)
  created_at  DateTime   @default(now())
  updated_at  DateTime   @updatedAt

  @@map(name: "stock_movements")
}
